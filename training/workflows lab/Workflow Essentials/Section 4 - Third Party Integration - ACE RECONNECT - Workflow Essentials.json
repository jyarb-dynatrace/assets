{"version":1,"defaultTimeframe":{"from":"now-2h","to":"now"},"sections":[{"id":"0","type":"markdown","markdown":"\nGoal: When a Davis problem event is triggered, send a problem summary as a Slack message to a chosen Slack channel.\n\n- Event Trigger\n    * Trigger Workflow when a Davis problem event is detected\n    * Events are filtered on the type of event, based on the previous exercise\n- Slack for Workflows\n    * Third party integration is typically accomplished with Workflow Apps\n    * The Slack for Workflows App provides an easy-to-use mechanism for sending messages to a Slack environment containing the data and context from Dynatrace\n    * Leverage Jinja expressions to access Workflow action results and implement logic\n\n### Slack for Workflows\nYour Dynatrace environment can integrate with a Slack workspace using Slack for Workflows. You can automate sending messages to Slack based on the events and schedules defined for your workflow.\n\n[Slack for Workflows Documentation](https://docs.dynatrace.com/docs/platform-modules/automations/workflows/actions/slack)\n\nSetting up the Slack integration is straight forward and well documented.  In the interest of time and simplicity, the Slack integration has already been configured for this lab."},{"id":"1","type":"markdown","markdown":"\nBegin by creating a new Workflow in the Workflows App within your Dynatrace environment.\n\n*Remember to save progress often!*\n\nSelect a trigger: choose `Davis problem trigger`\n\nFilter the events that will trigger this workflow.\n\nEvent state:\n```\nactive or closed\n```\n\nEvent category:\n```\nCustom\n```\n\nAffected entities:\n```\ninclude entities with all defined tagged below\n```\n\nAdditional custom filter query:\n```\nmatchesPhrase(event.name,\"EasyTravel Journey Amount\")\n```\n\n![../../../assets/images/04-workflow-trigger-type.png](../../../assets/images/04-workflow-trigger-type.png)"},{"id":"2","type":"markdown","markdown":"\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\n![../../../assets/images/04-set-parameters-action-type.png](../../../assets/images/04-set-parameters-action-type.png)\n\n---\n#### `js_set_parameters`\nName:\n```text\njs_set_parameters\n```\nDescription:\n```text\nSet the parameters for this workflow\n```\n\nThis will be the task/action that defines the parameters/variables that will be used by subsequent tasks and returns them in the result.  By setting the parameters as nested attribute key:value pairs within a single variable, as additional parameters are needed they can easily be added without modifying any other code.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nexport default async function () {\n\n  let PARAMETERS = {\n\n    // SLACK_CHANNEL - the Slack channel name (without the #) that the Slack bot has been added to\n    SLACK_CHANNEL: \"\", // i.e. SLACK_CHANNEL: \"workflow-essentials\",\n    \n  }\n  \n  return PARAMETERS;\n}\n```\n\nSet the value of the missing variables:\n- SLACK_CHANNEL:\n    * Use the channel name you have been provided (or have created)\n\n![../../../assets/images/04-set-parameters-input.png](../../../assets/images/04-set-parameters-input.png)"},{"id":"3","type":"markdown","markdown":"\n#### `slack_send_message`\nName:\n```text\nslack_send_message\n```\nDescription:\n```text\nSend problem summary in Slack\n```\n\nThis will be the task/action that uses the Slack connection to send a problem summary message to a Slack channel.\n\nLocate the `js_set_parameters` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Send message` action type from the Slack for Workflows section/app.\n\n![../../../assets/images/04-send-message-action-type.png](../../../assets/images/04-send-message-action-type.png)\n\nSet the task name and description respectively.\n\nConfigure the Send message action `Input`:\n\nConnection:\n```\nworkflow_essentials_demo\n```\n*This connection was created by the Workflow Essentials - Config Generator workflow*\n\nChannel:\n```\n{{ result(\"js_set_parameters\")['SLACK_CHANNEL'] }}\n```\n\nMessage:\n```\n{\n\t\"blocks\": [\n\t\t{\n\t\t\t\"type\": \"section\",\n\t\t\t\"block_id\": \"sectionHeader\",\n\t\t\t\"text\": {\n\t\t\t\t\"type\": \"mrkdwn\",\n\t\t\t\t\"text\": \"Dynatrace :dt: Problem Detection \\n Workflow Execution: [{{ execution().id }}]\"\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"type\": \"divider\"\n\t\t},\n\t\t{\n\t\t\t\"type\": \"section\",\n\t\t\t\"block_id\": \"problemState\",\n\t\t\t\"text\": {\n\t\t\t\t\"type\": \"mrkdwn\",\n\t\t\t\t\"text\": \"Problem State: {% if event()['event.status'] == 'ACTIVE' %} :warning: OPEN :warning: {% endif %} {% if event()['event.status'] == 'CLOSED' %} :white_check_mark: RESOLVED :white_check_mark: {% endif %}\"\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"type\": \"divider\"\n\t\t},\n\t\t{\n\t\t\t\"type\": \"section\",\n\t\t\t\"block_id\": \"problemSummary\",\n\t\t\t\"text\": {\n\t\t\t\t\"type\": \"mrkdwn\",\n\t\t\t\t\"text\": \"Problem Number: [*{{ event()['display_id'] }}*] \\n Problem ID: [ {{ event()['event.id'] }} ] \\n [ {{ event()['event.name'] }} ]\"\n\t\t\t}\n\t\t},\n\t\t{\n\t\t\t\"type\": \"divider\"\n\t\t},\n\t\t{\n\t\t\t\"type\": \"actions\",\n\t\t\t\"elements\": [\n\t\t\t\t{\n\t\t\t\t\t\"type\": \"button\",\n\t\t\t\t\t\"text\": {\n\t\t\t\t\t\t\"type\": \"plain_text\",\n\t\t\t\t\t\t\"text\": \"View Problem\",\n\t\t\t\t\t\t\"emoji\": true\n\t\t\t\t\t},\n\t\t\t\t\t\"value\": \"problem\",\n\t\t\t\t\t\"url\": \"{{ environment().url }}/ui/apps/dynatrace.classic.problems/#problems/problemdetails;pid={{ event()['event.id'] }}\"\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\t\"type\": \"button\",\n\t\t\t\t\t\"text\": {\n\t\t\t\t\t\t\"type\": \"plain_text\",\n\t\t\t\t\t\t\"text\": \"View Workflow Execution\",\n\t\t\t\t\t\t\"emoji\": true\n\t\t\t\t\t},\n\t\t\t\t\t\"value\": \"workflow\",\n\t\t\t\t\t\"url\": \"{{ environment().url }}/ui/apps/dynatrace.automations/executions/{{ execution().id }}\"\n\t\t\t\t}\n\t\t\t]\n\t\t}\n\t]\n}\n```\n\n![../../../assets/images/04-send-message-input.png](../../../assets/images/04-send-message-input.png)\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_set_parameters` is `success`\n\nAdditionally, we only want this task to run if the `EASYTRAVEL_URL` parameter is defined in the previous task.  We can access the result using a Jinja expression:\n```\n1. {{ result(\"task_name\") }}\n2. {{ result(\"task_name\")['result_attribute_name'] }}\n3. {{ result(\"task_name\")['result_attribute_name'] condition expression }}\n```\n\n[Expression Reference Documentation](https://docs.dynatrace.com/docs/platform-modules/automations/workflows/reference)\n\nSet the `And custom condition was met`:\n```\n{{ result(\"js_set_parameters\")['SLACK_CHANNEL'] is defined }}\n```\n\n![../../../assets/images/04-send-message-conditions.png](../../../assets/images/04-send-message-conditions.png)"},{"id":"4","type":"markdown","markdown":"\nOpen the Workflow Essentials - Ingest and Alert workflow from the previous exercise.  Run the workflow and validate the results.  A new problem event should have been created.\n\n![../../../assets/images/04-ingest-and-alert-execution-results.png](../../../assets/images/04-ingest-and-alert-execution-results.png)\n\nShortly after running the other workflow, the Workflow Essentials - Slack Integration workflow should have triggered as a result of the problem event.  Check the execution and validate the results.  Open the Slack channel and validate that the message contains the problem summary.\n\n![../../../assets/images/04-slack-integration-execution-results.png](../../../assets/images/04-slack-integration-execution-results.png)\n\nThird party integrations are available as Workflow Action Apps, which are available in the Hub.\n\n![../../../assets/images/04-workflow-action-apps-in-hub.png](../../../assets/images/04-workflow-action-apps-in-hub.png)"}]}