{"version":1,"defaultTimeframe":{"from":"now-2h","to":"now"},"sections":[{"id":"0","type":"markdown","markdown":"\nGoal: Retrieve data from an external system and ingest it as a metric.  If the value crosses a configured threshold, then generate an event/alert.\n\n- Credential Vault\n    * Access an API token from the Credential Vault using the Dynatrace SDK\n- Metric Ingest\n    * Retrieve data from an external system using HTTP GET\n    * Ingest retrieved data point using the Dynatrace API with API token (not optimal)\n    * Ingest retrieved data point using the Dynatrace SDK (optimal)\n- Event Ingest\n    * Query ingested metric data point using DQL\n    * Evaluate metric value against a threshold\n    * If the threshold is breached, generate an event using the Dynatrace SDK"},{"id":"1","type":"markdown","markdown":"\nBegin by creating a new Workflow in the Workflows App within your Dynatrace environment.\n\n*Remember to save progress often!*\n\nSelect a trigger: choose `On demand trigger`\n\n![../../../assets/images/03-workflow-trigger-type.png](../../../assets/images/03-workflow-trigger-type.png)\n\nClick the `+` button to add a new action to the Workflow.\n\n![../../../assets/images/03-add-first-action.png](../../../assets/images/03-add-first-action.png)\n\nChoose action: choose `Run JavaScript` action type.\n\n![../../../assets/images/03-set-parameters-choose-action.png](../../../assets/images/03-set-parameters-choose-action.png)\n\n---\n#### `js_set_parameters`\nName:\n```text\njs_set_parameters\n```\nDescription:\n```text\nSet the parameters for this workflow\n```\n\nThis will be the task/action that defines the parameters/variables that will be used by subsequent tasks and returns them in the result.  By setting the parameters as nested attribute key:value pairs within a single variable, as additional parameters are needed they can easily be added without modifying any other code.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nexport default async function () {\n\n  let PARAMETERS = {\n\n    // EASYTRAVEL_URL - the URL to the easytravel rest API to search for journeys and receive JSON payload\n    EASYTRAVEL_URL: \"http://aeb26f2507d934338baf67206067edef-612923892.us-east-1.elb.amazonaws.com/easytravel/rest/journeys/?match=Dallas&from=&to=\", // i.e. EASYTRAVEL_URL: \"http://aeb26f2507d934338baf67206067edef-612923892.us-east-1.elb.amazonaws.com/easytravel/rest/journeys/?match=Dallas&from=&to=\"\n  \n    // METRIC - the unique metric id to ingest a data point for the easytravel journey amount\n    METRIC: \"custom.workflow_essentials.easytravel.journey_amount\", // i.e. METRIC: \"custom.workflow_essentials.easytravel.journey_amount\"\n  \n    // CREDENTIAL - the credential vault entity ID that holds the Dynatrace API token value with metrics.ingest scope\n    CREDENTIAL: \"\", // i.e. CREDENTIAL: \"CREDENTIALS_VAULT-123ABCF8F36FD\"\n\n    // INGEST_URL - the URL of the dynatrace metric ingest API endpoint\n    INGEST_URL: \"https://<tenant-id>.live.dynatrace.com/api/v2/metrics/ingest\", // i.e. INGEST_URL: \"https://abc123.live.dynatrace.com/api/v2/metrics/ingest\"\n\n    // THRESHOLD - the threshold amount to trigger an alert event\n    THRESHOLD: 500, // i.e. THRESHOLD: 500; trigger an alert event if the average journey amount is above 500.00\n    \n  }\n  \n  return PARAMETERS;\n}\n```\n\nSet the value of the missing variables:\n- CREDENTIAL:\n    * Use the credential vault entry ID from the Workflow Essentials - Config Generator workflow execution\n- INGEST_URL:\n    * Replace `<tenant-id>` with your Dynatrace environment ID, i.e. `abc123`\n\n![../../../assets/images/03-set-parameters-input.png](../../../assets/images/03-set-parameters-input.png)"},{"id":"2","type":"markdown","markdown":"\n#### `http_easytravel_search`\nName:\n```text\nhttp_easytravel_search\n```\nDescription:\n```text\nQuery external easytravel API for journey data\n```\n\nThis will be the task/action that queries external data from an api endpoint that contains our metric data point.\n\nLocate the `js_set_parameters` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `HTTP Request` action type.\n\nSet the task name and description respectively.\n\nConfigure the HTTP Request action `Input`:\n\nMethod:\n```\nGET\n```\n\nURL:\n```\n{{ result(\"js_set_parameters\")['EASYTRAVEL_URL'] }}\n```\n\nHeaders:\n```\naccept  application/json\n```\n\nError Handling:\n```\nFail on certain HTTP response codes [Enabled]\n```\n\nHTTP error codes:\n```\n400-599\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_set_parameters` is `success`\n\nAdditionally, we only want this task to run if the `EASYTRAVEL_URL` parameter is defined in the previous task.  We can access the result using a Jinja expression:\n```js\n1. {{ result(\"task_name\") }}\n2. {{ result(\"task_name\")['result_attribute_name'] }}\n3. {{ result(\"task_name\")['result_attribute_name'] condition expression }}\n```\n\n[Expression Reference Documentation](https://docs.dynatrace.com/docs/platform-modules/automations/workflows/reference)\n\nSet the `And custom condition was met`:\n```\n{{ result(\"js_set_parameters\")['EASYTRAVEL_URL'] is defined }}\n```\n\n![../../../assets/images/03-http-easytravel-search-input.png](../../../assets/images/03-http-easytravel-search-input.png)\n\nRun the workflow and validate the results\n\n![../../../assets/images/03-http-easytravel-search-results.png](../../../assets/images/03-http-easytravel-search-results.png)"},{"id":"3","type":"markdown","markdown":"\n#### `js_get_credential`\nName:\n```text\njs_get_credential\n```\nDescription:\n```text\nAccess API token from the credential vault\n```\n\nThis will be the task/action that uses the Dynatrace SDK to retrieve a credential from the vault.  Confidential data and parameters should be stored in the credential vault and not statically defined in the code.\n\nLocate the `http_easytravel_search` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { credentialVaultClient } from '@dynatrace-sdk/client-classic-environment-v2';\n\nconst PARAMETERS_TASK = 'js_set_parameters';\n\nexport default async function ({ execution_id }) {\n\n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n  // CREDENTIAL\n  const CREDENTIAL = parameters['CREDENTIAL'];\n\n  // get the credentials from the credential vault using the SDK\n  // https://developer.dynatrace.com/develop/sdks/client-classic-environment-v2/#getcredentialsdetails\n  const data = (await credentialVaultClient.getCredentialsDetails({id: CREDENTIAL}));\n  const token = data['token'];\n  \n  return { token: token };\n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `http_easytravel_search` is `success`\n\nAdditionally, we only want this task to run if the `status_code` is `200` and the response is not empty in the previous task.\n\nSet the `And custom condition was met`:\n```\n{{ result(\"http_easytravel_search\")[\"status_code\"] == 200 and result(\"http_easytravel_search\")[\"json\"] | length > 0 }}\n```\n\n![../../../assets/images/03-get-credential-input.png](../../../assets/images/03-get-credential-input.png)"},{"id":"4","type":"markdown","markdown":"\n#### `http_ingest_metric`\nName:\n```text\nhttp_ingest_metric\n```\nDescription:\n```text\nIngest a metric data point using the metric API\n```\n\nThis will be the task/action that ingests a metric data point from the previous task using an HTTP call to the metric ingest API with a token from the credential vault.\n\nLocate the `js_get_credential` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `HTTP Request` action type.\n\nSet the task name and description respectively.\n\nConfigure the HTTP Request action `Input`:\n\nMethod:\n```\nPOST\n```\n\nURL:\n```\n{{ result(\"js_set_parameters\")['INGEST_URL'] }}\n```\n\nPayload:\n```\n{{ result(\"js_set_parameters\")[\"METRIC\"] }},id={{ result(\"http_easytravel_search\")[\"json\"][0][\"id\"] }},destination={{ result(\"http_easytravel_search\")[\"json\"][0][\"destination\"] }} {{ result(\"http_easytravel_search\")[\"json\"][0][\"amount\"] }}\n```\n\nHeaders:\n```\nContent-Type  text/plain\nAuthorization   Api-Token {{ result(\"js_get_credential\")[\"token\"] }}\n```\n\nError Handling:\n```\nFail on certain HTTP response codes [Enabled]\n```\n\nHTTP error codes:\n```\n400-599\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_get_credential` is `success`\n\nAdditionally, we only want this task to run if the `token` parameter is defined in the previous task.\n\nSet the `And custom condition was met`:\n```\n{{ result(\"js_get_credential\")['token'] is defined }}\n```\n\n![../../../assets/images/03-http-ingest-metric-input.png](../../../assets/images/03-http-ingest-metric-input.png)\n\nRun the workflow and validate the results\n\n![../../../assets/images/03-http-ingest-metric-results.png](../../../assets/images/03-http-ingest-metric-results.png)"},{"id":"5","type":"markdown","markdown":"\n#### `js_ingest_metric_sdk`\nName:\n```text\njs_ingest_metric_sdk\n```\nDescription:\n```text\nIngest a metric data point using the SDK\n```\n\nThis will be the task/action that uses the Dynatrace SDK to ingest a metric data point.  The SDK makes it significantly easier to perform this function than using the API and authorization token.\n\nLocate the `http_easytravel_search` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { metricsClient } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\nconst PARAMETERS_TASK = 'js_set_parameters';\nconst SEARCH_TASK = 'http_easytravel_search';\n\nexport default async function ({ execution_id }) {\n\n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n  const METRIC = parameters['METRIC'];\n  // previous results\n  const search_results = await ex.result(SEARCH_TASK);\n  const id = search_results['json'][0]['id'];\n  const amount = search_results['json'][0]['amount'];\n  const destination = search_results['json'][0]['destination'];\n\n  // build the line_protocol string to ingest the metric data point\n  const line_protocol = METRIC + ',id=' + id + ',destination=' + destination + ' ' + amount;\n  // (optional) log the line_protocol value\n  console.log(line_protocol);\n  // ingest the metric data point using the SDK\n  // https://developer.dynatrace.com/develop/sdks/client-classic-environment-v2/#ingest-1\n  const data = await metricsClient.ingest({\n    body: line_protocol,\n  });\n  \n  return { data: data };\n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `http_easytravel_search` is `success`\n\nAdditionally, we only want this task to run if the `status_code` is `200` and the response is not empty in the previous task.\n\nSet the `And custom condition was met`:\n```\n{{ result(\"http_easytravel_search\")[\"status_code\"] == 200 and result(\"http_easytravel_search\")[\"json\"] | length > 0 }}\n```\n\n![../../../assets/images/03-ingest-metric-sdk-input.png](../../../assets/images/03-ingest-metric-sdk-input.png)\n\nRun the workflow and validate the results\n\n![../../../assets/images/03-ingest-metric-sdk-results.png](../../../assets/images/03-ingest-metric-sdk-results.png)"},{"id":"6","type":"markdown","markdown":"\n#### `js_wait_30_seconds`\nName:\n```text\njs_wait_30_seconds\n```\nDescription:\n```text\nWait 30 seconds for data to be processed\n```\n\nThis will be the task/action that pauses workflow execution for 30 seconds with a timed wait using JS code.  This method can be useful when you need to pause task execution within your JS code task.  Additionally, you can configure any task to wait up to 60 seconds in the `Options` tab.\n\nWhen data is ingested into the Dynatrace platform, it may not be available immediately.  To avoid a query from returning an empty result set, we'll wait 30 seconds for the data to be processed before continuing.\n\nLocate the `http_ingest_metric` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nLocate the `js_ingest_metric_sdk` task.\n\nClick *and hold* the `+` button, then *drag* to connect this task to the `js_wait_30_seconds` task.\n\nPaste the following code snippet into the action `Input`:\n```\nexport default async function () {\n\n  const sleep = async (waitTime: number) =>\n  new Promise(resolve =>\n    setTimeout(resolve, waitTime));\n  \n  const waitTime = async () => {\n  // 30,000ms = 30 seconds to sleep\n  await sleep(30000);\n  console.log(\"Finished Waiting\");\n  }\n\n  console.log(\"Waiting 30 Seconds\");\n  waitTime();\n  \n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_ingest_metric_sdk` is `success` and `http_ingest_metric` is `success`\n\n![../../../assets/images/03-wait-30-seconds-input.png](../../../assets/images/03-wait-30-seconds-input.png)\n\n---\n#### `js_dql_query_alert`\nName:\n```text\njs_dql_query_alert\n```\nDescription:\n```text\nQuery metric data point and generate an alert via SDK\n```\n\nThis will be the task/action that uses the Dynatrace SDK to execute a DQL query to retrieve a metric data point and trigger an alert event if the value crosses a threshold.  Using the Dynatrace SDK is an alternative method for running a DQL query within workflows.  When a Davis problem event is triggered using the Dynatrace SDK within workflows, the event is stored in Grail and the problem is available in the Problems app.\n\nLocate the `js_wait_30_seconds` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution } from '@dynatrace-sdk/automation-utils';\nimport { queryExecutionClient } from \"@dynatrace-sdk/client-query\";\nimport { eventsClient, EventIngestEventType } from \"@dynatrace-sdk/client-classic-environment-v2\";\n\nconst PARAMETERS_TASK = 'js_set_parameters';\nconst SEARCH_TASK = 'http_easytravel_search';\n\nexport default async function ({ execution_id }) {\n\n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n  const METRIC = parameters['METRIC'];\n  const THRESHOLD = parameters['THRESHOLD'];\n  // previous results\n  const search_results = await ex.result(SEARCH_TASK);\n  const destination = search_results['json'][0]['destination'];\n  \n  // build the DQL query for the metric\n  // query the metric value for the last 5 minutes\n  // https://developer.dynatrace.com/develop/sdks/client-query/#queryexecute\n  const timeout = 60;\n  const query = 'timeseries journey_amount = avg(' + METRIC + '), by: {destination}, from: now()-5m\\\n                  | filter destination == \"' + destination + '\"\\\n                  | summarize avg_amount = avg(arrayAvg(journey_amount))';\n  \n  const query_response = await queryExecutionClient.queryExecute({ body: { query, requestTimeoutMilliseconds: timeout * 1000, fetchTimeoutSeconds: timeout  } });\n\n  // check if the query result is empty (unexpectedly)\n  if(query_response.result.records.length == 0) {\n    console.log(\"Query returned an empty result unexpectedly!\");\n    return query_response.result;\n  }\n\n  // capture the average journey amount from query response\n  const avg_amount = parseFloat(query_response.result.records[0]['avg_amount']);\n\n  // check if the avg amount value is above the threshold parameter, if true then raise alert event\n  if(avg_amount > THRESHOLD) {\n\n    // https://developer.dynatrace.com/develop/sdks/client-classic-environment-v2/#createevent\n    const event_response = await eventsClient.createEvent({\n      // https://developer.dynatrace.com/develop/sdks/client-classic-environment-v2/#eventingest\n      body : {\n        eventType: EventIngestEventType.CustomAlert, // https://developer.dynatrace.com/develop/sdks/client-classic-environment-v2/#eventingesteventtype\n        title: 'EasyTravel Journey Amount [ ' + avg_amount + ' ]',\n        timeout: 5,\n        properties: {\n          'amount': avg_amount,\n          'threshold' : THRESHOLD,\n        }\n      }\n    });\n    \n    // validate that the alert event was created, return the correlationId and details\n    if(event_response.eventIngestResults[0].status == \"OK\") {\n      return {\n        amount: avg_amount,\n        threshold: THRESHOLD,\n        correlationId: event_response.eventIngestResults[0].correlationId\n      }\n    } else {\n      return {\n        amount: avg_amount,\n        threshold: THRESHOLD,\n        correlationId: \"ERROR\"\n      }\n    }\n  }\n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_wait_30_seconds` is `success`\n\n![../../../assets/images/03-dql-query-alert-input.png](../../../assets/images/03-dql-query-alert-input.png)\n\nRun the workflow and validate the results\n\n![../../../assets/images/03-dql-query-alert-results.png](../../../assets/images/03-dql-query-alert-results.png)\n\nAfter validating that the workflow execution was successful and the `js_dql_query_alert` result has a populated `correlationId` value, open the Problems (or Problems (Classic)) app and view the open problem alert.\n\n![../../../assets/images/03-problem-card.png](../../../assets/images/03-problem-card.png)"}]}