{"version":1,"defaultTimeframe":{"from":"now-2h","to":"now"},"sections":[{"id":"0","type":"markdown","markdown":"\nGoal: Utilize essential Workflow techniques applicable to most use cases.\n\n- Parameters and Task Results\n    * Parameter Task – define parameters/variables that will be used by subsequent tasks\n    * Parameter Task Output – return parameters for subsequent tasks\n    * Accessing Parameter Task Results – access the parameters from result of the task\n- Fetch API\n    * HTTP GET  (Dynatrace Status.io) – bring external data into Dynatrace workflows\n    * HTTP POST  (Webhook.Site) – send data to external systems from Dynatrace workflows\n- Looping Tasks\n    * DQL Query – execute a DQL query that returns multiple records/rows\n    * Looping Over Results – perform logic against each DQL record/row"},{"id":"1","type":"markdown","markdown":"\nBegin by creating a new Workflow in the Workflows App within your Dynatrace environment.\n\n*Remember to save progress often!*\n\nSelect a trigger: choose `On demand trigger`\n\n![../../../assets/images/02-workflow-trigger-type.png](../../../assets/images/02-workflow-trigger-type.png)\n\nClick the `+` button to add a new action to the Workflow.\n\n![../../../assets/images/02-add-first-action.png](../../../assets/images/02-add-first-action.png)\n\nChoose action: choose `Run JavaScript` action type.\n\n![../../../assets/images/02-set-parameters-choose-action.png](../../../assets/images/02-set-parameters-choose-action.png)\n\n\n#### `js_set_parameters`\n\nName:\n```text\njs_set_parameters\n```\nDescription:\n```text\nSet the parameters for this workflow\n```\n\nThis will be the task/action that defines the parameters/variables that will be used by subsequent tasks and returns them in the result.  By setting the parameters as nested attribute key:value pairs within a single variable, as additional parameters are needed they can easily be added without modifying any other code.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n\n```\nexport default async function () {\n\n  let PARAMETERS = {\n\n    // INITIALS - the initials of the user for this lab\n    INITIALS: \"\", // i.e. INITIALS: \"TPC\"; the intials of the user for this lab are TPC\n  \n    // LOCATION - the city and country of the user for this lab\n    LOCATION: \"\", // i.e. LOCATION: \"Dallas, United States\";\n  \n    // TENURE - the number of years of tenure of the user for this lab\n    TENURE: ##, // i.e. TENURE: 14; the user for this lab has 14 years of tenure\n\n    // STATUS_URL - the URL of the dynatrace status.io API\n    STATUS_URL: \"https://api.status.io/1.0/status/546d8cb6af8407b6730000cb\", // i.e. STATUS_URL: \"https://api.status.io/1.0/status/546d8cb6af8407b6730000cb\"\n\n    // WEBHOOK_URL- the URL of the webhook.site unique endpoint\n    WEBHOOK_URL: \"\", // i.e. WEBHOOK_URL: \"https://webhook.site/18637ec8-fcf9-43ec-86bf-993626982c6c\"\n  \n  }\n  \n  return PARAMETERS;\n}\n```\n\nSet the value of the missing variables:\n- INITIALS: your initials\n- LOCATION: your location\n- TENURE: the number of years you've been with the company\n- WEBHOOK_URL:\n    * Navigate in your incognito browser window to https://webhook.site/ and copy your unique URL\n      * The unique URL is located at the top of the page, not in your browser's address bar\n\n![../../../assets/images/02-set-parameters-input.png](../../../assets/images/02-set-parameters-input.png)\n\n#### `js_output_parameters`\n\nName:\n```text\njs_output_parameters\n```\nDescription:\n```text\nOutput the parameters from the previous task\n```\n\nThis will be the task/action that accesses the parameters from the previous tasks results.  This will demonstrate how to do this within JS code.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution } from '@dynatrace-sdk/automation-utils';\n\nconst PARAMETERS_TASK = 'js_set_parameters';\n\nexport default async function ({ execution_id }) {\n  \n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n\n  // log the parameters\n  console.log(parameters);\n\n  // declare new variables to easily access the parameters within this task\n  const INITIALS = parameters['INITIALS'];\n  const LOCATION = parameters['LOCATION'];\n  const TENURE = parameters['TENURE'];\n\n  // return a string that contains the parameters\n  return \"The lab user \" + INITIALS + \", is located in \" + LOCATION + \".  They have \" + TENURE + \" years of tenure.\";\n  \n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_set_parameters` is `success`\n\n![../../../assets/images/02-output-parameters-input.png](../../../assets/images/02-output-parameters-input.png)\n\nRun the workflow and validate the results\n\n![../../../assets/images/02-output-parameters-results.png](../../../assets/images/02-output-parameters-results.png)"},{"id":"2","type":"markdown","markdown":"\n#### `js_fetch_status_io`\n\nName:\n```text\njs_fetch_status_io\n```\nDescription:\n```text\nRead dynatrace status.io using fetch api\n```\n\nThis will be the task/action that uses the `fetch()` api to make an HTTP call to the Dynatrace status.io api.  This will demonstrate how to make HTTP calls using JS code, in order to bring in external data.\n\nLocate the `js_set_parameters` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution } from '@dynatrace-sdk/automation-utils';\n\nconst PARAMETERS_TASK = 'js_set_parameters';\n\nexport default async function ({ execution_id }) {\n\n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n  // STATUS_URL\n  const STATUS_URL = parameters['STATUS_URL'];\n  \n  // set the fetch() api parameters [method, headers, body]\n  // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch\n  const options = {\n    method: \"GET\",\n    headers: {\n      'accept': \"application/json\",\n    }\n  };\n  \n  // execute the fetch() api call\n  // set the url parameter equal to the status.io url parameter\n  const url = STATUS_URL;\n  // make the fetch call, passing the url and options, capture the response\n  const response = await fetch(url,options);\n  // parse the json response as a new variable\n  const response_json = await response.json();\n  // return the json response\n  return response_json;\n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_set_parameters` is `success`\n\nAdditionally, we only want this task to run if the `STATUS_URL` parameter is defined in the previous task.  We can access the result using a Jinja expression:\n```js\n1. {{ result(\"task_name\") }}\n2. {{ result(\"task_name\")['result_attribute_name'] }}\n3. {{ result(\"task_name\")['result_attribute_name'] condition expression }}\n```\n\n[Expression Reference Documentation](https://docs.dynatrace.com/docs/platform-modules/automations/workflows/reference)\n\nSet the `And custom condition was met`:\n```js\n{{ result(\"js_set_parameters\")['STATUS_URL'] is defined }}\n```\n\n![../../../assets/images/02-fetch-status-io-input.png](../../../assets/images/02-fetch-status-io-input.png)\n\n---\n#### `js_fetch_webhook_site`\n\nName:\n```text\njs_fetch_webhook_site\n```\nDescription:\n```text\nSend json content to webhook.site using fetch api\n```\n\nThis will be the task/action that uses the `fetch()` api to make an HTTP call to webhook.site, a free webhook testing tool.  This will demonstrate how to make HTTP calls using JS code, in order to send data from workflows to external systems.\n\nLocate the `js_fetch_status_io` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution } from '@dynatrace-sdk/automation-utils';\n\nconst PARAMETERS_TASK = 'js_set_parameters';\nconst FETCH_STATUS_TASK = 'js_fetch_status_io';\n\nexport default async function ({ execution_id }) {\n\n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n  // WEBHOOK_URL\n  const WEBHOOK_URL = parameters['WEBHOOK_URL'];\n\n  // get results from previous task\n  // fetch status task result\n  const status_result = await ex.result(FETCH_STATUS_TASK);\n  \n  // set the fetch() api parameters [method, headers, body]\n  // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch\n  const options = {\n    method: \"POST\",\n    headers: {\n      'content-type': \"application/json\",\n    },\n    body: JSON.stringify(status_result)\n  };\n  \n  // execute the fetch() api call\n  // set the url parameter equal to the status.io url parameter\n  const url = WEBHOOK_URL;\n  // make the fetch call, passing the url and options, capture the response\n  const response = await fetch(url,options);\n  // capture the response code\n  const response_status = response.status\n\n  return response_status;\n}\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_fetch_status_io` is `success`\n\nAdditionally, we only want this task to run if the `result` attribute is defined in the previous task.  We can access the result using a Jinja expression:\n\nSet the `And custom condition was met`:\n```\n{{ result(\"js_fetch_status_io\")['result'] is defined }}\n```\n\n![../../../assets/images/02-fetch-webhook-site-input.png](../../../assets/images/02-fetch-webhook-site-input.png)\n\nRun the workflow and validate the results\n\n![../../../assets/images/02-fetch-webhook-site-results.png](../../../assets/images/02-fetch-webhook-site-results.png)"},{"id":"3","type":"markdown","markdown":"\n#### `dql_query_bizevents`\nName:\n```text\ndql_query_bizevents\n```\nDescription:\n```text\nQuery bizevents\n```\n\nThis will be the task/action that queries bizevents that are being generated from the data generator workflow.  This will demonstrate how to query data from Dynatrace (Grail) and use the data/results in subsequent tasks.\n\nLocate the `js_fetch_status_io` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Execute DQL Query` action type.\n\nSet the task name and description respectively.\n\nPaste the following DQL query into the action `Input`:\n```sql\nfetch bizevents, from: now()-2h\n| filter event.provider == \"workflow.essentials.withdraw-processing\"\n| summarize count = count(), by: {step = event.type}\n| sort step asc\n```\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `js_fetch_status_io` is `success`\n\n![../../../assets/images/02-query-bizevents-input.png](../../../assets/images/02-query-bizevents-input.png)\n\n---\n#### `js_loop_over_results`\nName:\n```text\njs_loop_over_results\n```\nDescription:\n```text\nExecute task for each loop item, bizevent record\n```\n\nThis will be the task/action that iterates over the results of a DQL query and performs desired activities.  If a result record matches a condition, it will use fetch() api to send data to webhook.site.\n\nLocate the `dql_query_bizevents` task.\n\nClick the `+` button to add a new action to the Workflow.\n\nChoose action: choose `Run JavaScript` action type.\n\nSet the task name and description respectively.\n\nPaste the following code snippet into the action `Input`:\n```\nimport { execution, actionExecution } from '@dynatrace-sdk/automation-utils';\nimport { getCurrentUserDetails,getEnvironmentId,getEnvironmentUrl } from '@dynatrace-sdk/app-environment';\n\nconst PARAMETERS_TASK = 'js_set_parameters';\n\nexport default async function ({ execution_id, action_execution_id }) {\n\n  // get parameters from previous tasks\n  // execution\n  const ex = await execution(execution_id);\n  // parameters\n  const parameters = await ex.result(PARAMETERS_TASK);\n  // WEBHOOK_URL\n  const WEBHOOK_URL = parameters['WEBHOOK_URL'];\n  \n  // get the loop item for the action execution\n  const actionEx = await actionExecution(action_execution_id);\n  const record = actionEx.loopItem['item'];\n  // log the loop item record\n  console.log(JSON.stringify(record));\n  // create variables for the step and count attributes within the record\n  const step = record['step'];\n  const count = record['count'];\n\n  // check if step is \"06.funds.received\", send webhook with details\n  if(step == \"06.funds.received\") {\n\n    // get a timestamp to send with the payload\n    // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/Date\n    const timestamp = new Date();\n\n    // Environment ID\n    const environment_id = getEnvironmentId();\n\n    // Workflow execution user details\n    const user_details = getCurrentUserDetails();\n    const user_name = user_details['name']; // get the user name\n    \n    // set the fetch() api parameters [method, headers, body]\n    // https://developer.mozilla.org/en-US/docs/Web/API/Fetch_API/Using_Fetch\n    const options = {\n      method: \"POST\",\n      headers: {\n        'content-type': \"application/json\",\n      },\n      body: JSON.stringify({\n        timestamp: timestamp.toISOString(), // https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/toISOString\n        step: step,\n        count: count,\n        environment: environment_id,\n        user: user_name\n      })\n    };\n    \n    // execute the fetch() api call\n    // set the url parameter equal to the status.io url parameter\n    const url = WEBHOOK_URL;\n    // make the fetch call, passing the url and options, capture the response\n    const response = await fetch(url,options);\n    // capture the response code\n    const response_status = response.status\n  \n    return { step: step, count: count, response: response_status };\n  }\n  \n  // return the step and count attributes\n  return { step: step, count: count };\n}\n```\n\n![../../../assets/images/02-loop-results-input.png](../../../assets/images/02-loop-results-input.png)\n\nClick on the task's `Conditions` tab.  Set the `Run this task if`: `dql_query_bizevents` is `success`\n\nAdditionally, we only want this task to run if the result of the previous task has a `records` array with a `length > 0`.\n\nSet the `And custom condition was met`:\n```\n{{ result(\"dql_query_bizevents\").records | length > 0 }}\n```\n*note* `result(\"dql_query_bizevents\").records` is the same as `result(\"dql_query_bizevents\")['records']`\n\nFinally, we want this task to execute as a loop.  This works by providing a `List` which is an array/list of data you want to iterate over and perform the task for each element/index.  You can provide data from a previous task using a Jinja expression.  You can access element/index through the provided `Item variable name`, either from JS code or Jinja expression.  Additionally, you can specify loop concurrency to increase parallel operations.\n\nClick on the task's `Options` tab.  Toggle on `Loop task` setting.\n\nSet the `Item variable name`:\n```\nitem\n```\n\nSet the `List`:\n```\n{{ result(\"dql_query_bizevents\").records }}\n```\n\n![../../../assets/images/02-loop-results-conditions-options.png](../../../assets/images/02-loop-results-conditions-options.png)\n\nThe loop item is access in our JS code with the following snippet:\n```\n// import the required package\nimport { actionExecution } from '@dynatrace-sdk/automation-utils';\n// declare function\nexport default async function ({ execution_id, action_execution_id }) {\n// get the loop item for the action execution\nconst actionEx = await actionExecution(action_execution_id);\nconst record = actionEx.loopItem['item'];\n// we can now use the contents of record\nconsole.log(record); // for example\n// end function\n}\n```\n\nRun the workflow and validate the results\n\n![../../../assets/images/02-loop-results-output-results.png](../../../assets/images/02-loop-results-output-results.png)\n"}]}