{"version":1,"defaultTimeframe":{"from":"now-2h","to":"now"},"sections":[{"id":"0","type":"markdown","markdown":"\nConfigure and use Segments to apply filters to data retrieved from Grail.\n\n* Configure basic Segments\n    - Kubernetes Cluster (IDP)\n    - Kubernetes Namespace (IDP)\n* Analyze with Segments"},{"id":"1","type":"markdown","markdown":"\nCreate Segments to filter analysis on Kubernetes properties, Cluster and Namespace\n\n### Segment: Kubernetes Cluster (IDP)\n\nIn the Dynatrace environment, locate and launch the `Segments` App.\n\n![Segments App](https://university.dynatrace.com/assets/50457/03_01_segments_app.png)\n\nClick on `+ Segment` to create a new Segment.\n\n![idp-k8s-cluster segment](https://university.dynatrace.com/assets/50457/03_01_idp_k8s_cluster_segment.png)\n\nName the Segment `idp-k8s-cluster`.\n\nBegin by defining a Variable for the Segment.\n\n![idp-k8s-cluster variable](https://university.dynatrace.com/assets/50457/03_01_idp_k8s_cluster_variable.png)\n\nIn your Variables configuration, enter the following DQL Query:\n\n```sql\nfetch dt.entity.kubernetes_cluster\n| fields name = entity.name, id, namespace = cluster_of[`dt.entity.cloud_application_namespace`]\n| expand namespace\n| lookup [fetch dt.entity.cloud_application_namespace\n          | filter in(entity.name,{\"argocd\",\"backstage\"})\n          | fields id, entity.name, cloudApplicationLabels\n          | fieldsFlatten cloudApplicationLabels\n          | fields id, name = entity.name, owner = `cloudApplicationLabels.dt.owner`\n          | filter owner == \"platform_team\"], sourceField: namespace, lookupField: id, prefix: \"namespace.\"\n| filterOut isNull(namespace.id)\n| summarize collectDistinct(id), by: {name, id, namespace.owner}\n| fields name, id, owner = namespace.owner\n```\n\nClick `Preview` to run the query.  You should see your `platform-engineering-demo` cluster details.\n\nClick `Done`.\n\n![idp-k8s-cluster segment](https://university.dynatrace.com/assets/50457/03_01_idp_k8s_cluster_segment.png)\n\nUnder Segment data, create a new rule for `All data types`.  Type to add a filter.  Use the following filter:\n\n```text\ndt.entity.kubernetes_cluster = \"$id\" OR k8s.cluster.name = \"$name\"\n```\n\nAdding this segment data filter to our Segment will apply to any Grail data queries when this Segment is applied.\n\nUnder Segment data, create a new rule for `Entities` > `Kubernetes cluster`.  Type to add a filter.  Use the following filter:\n\n```text\nentity.name = \"$name\"\n```\n\nAdd related Kubernetes entities to the Segment data filter.  Click on `+ Related entity` and choose `Kubernetes namespace`.  This will include any Kubernetes namespace entity that is related to the Kubernetes cluster.  Repeat this process for ALL related entity types.\n\nAs you make your configurations, clicking on `Preview` will allow you to see which entities or data types matched your filter.\n\nWhen your Segment configuration is complete, click on `Save`.\n\nNote: You can change the visibility of your Segment, however if you are the only one accessing the environment, this is irrelevant.\n\n### Segment: Kubernetes Namespace (IDP)\n\nClick on `+ Segment` to create a new Segment.\n\n![idp-k8s-namespace segment](https://university.dynatrace.com/assets/50457/03_01_idp_k8s_namespace_segment.png)\n\nName the Segment `idp-k8s-namespace`.\n\nBegin by defining a Variable for the Segment.\n\n![idp-k8s-namespace variable](https://university.dynatrace.com/assets/50457/03_01_idp_k8s_namespace_variable.png)\n\nIn your Variables configuration, enter the following DQL Query:\n\n```sql\nfetch dt.entity.cloud_application_namespace\n| fields id, entity.name, owner = cloudApplicationLabels[`dt.owner`], cluster = clustered_by[`dt.entity.kubernetes_cluster`]\n| lookup [fetch dt.entity.kubernetes_cluster\n          | fields id, entity.name], sourceField:cluster, lookupField: id, prefix: \"cluster.\"\n| filterOut isNull(cluster.id) OR isNull(owner) OR owner == \"platform_team\"\n| fields name = entity.name, id, cluster.id, cluster.name = cluster.entity.name, owner\n```\n\nClick `Preview` to run the query.  You should see your `simplenodeservice-*-*` namespace details.\n\nClick `Done`.\n\n![idp-k8s-namespace segment](https://university.dynatrace.com/assets/50457/03_01_idp_k8s_namespace_segment.png)\n\nUnder Segment data, create a new rule for `All data types`.  Type to add a filter.  Use the following filter:\n\n```text\nk8s.namespace.name = \"$name\" OR dt.entity.cloud_application_namespace = \"$id\"\n```\n\nAdding this segment data filter to our Segment will apply to any Grail data queries when this Segment is applied.\n\nUnder Segment data, create a new rule for `Entities` > `Kubernetes namespace`.  Type to add a filter.  Use the following filter:\n\n```text\nentity.name = \"$name\"\n```\n\nAdd related Kubernetes entities to the Segment data filter.  Click on `+ Related entity` and choose `Kubernetes cluster`.  This will include any Kubernetes cluster entity that is related to the Kubernetes cluster.  Type to add a filter.  Use the following filter:\n\n```text\nid = \"$cluster.id\" OR entity.name = \"$cluster.name\"\n```\n\nNext, click on `+ Related entity` and choose `Kubernetes service`.  Do not apply any additional filter.\n\nRepeat this process for ALL related entity types.\n\nAs you make your configurations, clicking on `Preview` will allow you to see which entities or data types matched your filter.\n\nWhen your Segment configuration is complete, click on `Save`.\n\nNote: You can change the visibility of your Segment, however if you are the only one accessing the environment, this is irrelevant.\n\n### Validate New Segments\n\nValidate that your new Segments have been created.\n\n![validate segments](https://university.dynatrace.com/assets/50457/03_01_validate_segments.png)"},{"id":"2","type":"markdown","markdown":"\nAnalyze the applications in Dynatrace, this time using the newly created Segments.\n\n### Explore IDP SimpleNodeServices Dashboard\n\nIf you haven't already, import the [IDP SimpleNodeServices](https://github.com/dynatrace-wwse/enablement-openpipeline-segments-iam/blob/main/lab-guide/assets/dynatrace/IDP_%20SimpleNodeServices_Dashboard.json) Dashboard into the Dynatrace environment.\n\n![IDP SimpleNodeServices Dashboard](https://university.dynatrace.com/assets/50457/02_03_idp_simplenodeservices_dashboard.png)\n\nUse the variable selector for `Namespace`.  Notice the long list of namespaces available to choose from.\n\n![Namespace Selector](https://university.dynatrace.com/assets/50457/03_02_dashboard_namespace_selector.png)\n\nThe variable is configured (via DQL query) to pick from every Kubernetes namespace detected in the Dynatrace environment, across all clusters.\n\nApply Segment filters to the dashboard.  Click on the `Segments` icon to open the Segments filter prompt (next to the timeframe selector).\n\n![Apply Segments](https://university.dynatrace.com/assets/50457/03_02_apply_segments_dashboard.png)\n\nStart by applying the `idp-k8s-cluster` Segment filter and choose the `platform-engineering-demo` Kubernetes cluster.\n\nThen apply the `idp-k8s-namespace` Segment filter and choose all (4) Kubernetes namespaces.\n\nClick `Apply` to apply the Segment filter(s) to the dashboard.\n\nUse the variable selector for `Namespace`.  Notice the reduced list of namespaces available to choose from.\n\n"}]}